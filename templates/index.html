{% extends "base.html" %}

{% block title %}Home - LEITZ Label Generator{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2>üìù Your Labels</h2>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-success" onclick="showAddLabelForm()">‚ûï Add New Label</button>
        <button class="btn" onclick="generateSelectedPDF()">ÔøΩÔ∏è Print Selected</button>
    </div>
</div>

<!-- Add/Edit Label Form (Hidden by default) -->
<div id="label-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <h3 id="form-title">Add New Label</h3>
    <form id="label-form-element" onsubmit="saveLabel(event)">
        <input type="hidden" id="label-index" value="">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" required onchange="updateShortCode()">
                    <option value="">Select category...</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="startyear">Start Year</label>
                <input type="number" id="startyear" min="1900" max="2100" required onchange="updateShortCode()">
            </div>
            
            <div class="form-group">
                <label for="shortcode">Short Code (Auto-generated)</label>
                <input type="text" id="shortcode" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            
            <div class="form-group">
                <label for="format">Format</label>
                <select id="format" required>
                    {% for format_name, size in config.label_sizes.items() %}
                    <option value="{{ format_name }}">{{ format_name|capitalize }} ({{ size.width_mm }}mm √ó {{ size.height_mm }}mm)</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="subcategories">Subcategories (separate with semicolon)</label>
            <textarea id="subcategories" rows="3" placeholder="e.g., Taxes;Payroll;Bank Statements" required></textarea>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn btn-success">üíæ Save Label</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddLabelForm()">‚ùå Cancel</button>
        </div>
    </form>
</div>

<!-- Labels Table -->
<div style="overflow-x: auto;">
    <table id="labels-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all" onchange="toggleAll(this.checked)">
                </th>
                <th>Category</th>
                <th>Code</th>
                <th>Year</th>
                <th>Subcategories</th>
                <th>Format</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if labels %}
                {% for label in labels %}
                <tr>
                    <td>
                        <input type="checkbox" class="label-checkbox" data-index="{{ loop.index0 }}">
                    </td>
                    <td><strong>{{ label.Category }}</strong></td>
                    <td>{{ label.ShortCode }}</td>
                    <td>{{ label.StartYear }}</td>
                    <td>{{ label.Subcategories }}</td>
                    <td>{{ label.Format }}</td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 0.9em;" onclick="editLabel({{ loop.index0 }})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9em;" onclick="deleteLabel({{ loop.index0 }})">üóëÔ∏è Delete</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                        No labels yet. Click "Add New Label" to get started! üöÄ
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
    <h3 style="margin-bottom: 10px;">üí° Quick Tips</h3>
    <ul style="margin-left: 20px; line-height: 1.8;">
        <li>Use the <strong>Print Selected</strong> button to see your labels before printing</li>
        <li>Labels are automatically arranged to fit on A4 pages</li>
        <li>Customize colors and styles in the <strong>Settings</strong> page</li>
        <li>The "Notfall" category gets special emergency styling</li>
        <li>To print: Open preview and use your browser's print function (Ctrl+P)</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
let labelsData = {{ labels | tojson }};
let configData = {{ config | tojson }};

function showAlert(message, isError = false) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = 'alert ' + (isError ? 'alert-error' : 'alert-success');
    alert.textContent = message;
    container.innerHTML = '';
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function updateShortCode() {
    const category = document.getElementById('category').value;
    const year = document.getElementById('startyear').value;
    
    if (category && year && configData.categories[category]) {
        const categoryCode = configData.categories[category].short_code;
        const shortCode = `${categoryCode}-${year}`;
        document.getElementById('shortcode').value = shortCode;
    } else {
        document.getElementById('shortcode').value = '';
    }
}

function showAddLabelForm() {
    document.getElementById('label-form').style.display = 'block';
    document.getElementById('form-title').textContent = 'Add New Label';
    document.getElementById('label-form-element').reset();
    document.getElementById('label-index').value = '';
    document.getElementById('shortcode').value = '';
}

function hideAddLabelForm() {
    document.getElementById('label-form').style.display = 'none';
    document.getElementById('label-form-element').reset();
}

function editLabel(index) {
    const label = labelsData[index];
    document.getElementById('label-form').style.display = 'block';
    document.getElementById('form-title').textContent = 'Edit Label';
    document.getElementById('label-index').value = index;
    document.getElementById('category').value = label.Category;
    document.getElementById('startyear').value = label.StartYear;
    document.getElementById('subcategories').value = label.Subcategories;
    document.getElementById('format').value = label.Format;
    // Auto-compute short code based on category and year
    updateShortCode();
}

async function saveLabel(event) {
    event.preventDefault();
    
    const indexInput = document.getElementById('label-index').value;
    const data = {
        Category: document.getElementById('category').value,
        ShortCode: document.getElementById('shortcode').value,
        StartYear: parseInt(document.getElementById('startyear').value),
        Subcategories: document.getElementById('subcategories').value,
        Format: document.getElementById('format').value
    };
    
    if (indexInput !== '') {
        data.index = parseInt(indexInput);
    }
    
    try {
        const response = await fetch('/api/labels', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message, true);
        }
    } catch (error) {
        showAlert('Error saving label: ' + error.message, true);
    }
}

async function deleteLabel(index) {
    if (!confirm('Are you sure you want to delete this label?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/labels?index=${index}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message, true);
        }
    } catch (error) {
        showAlert('Error deleting label: ' + error.message, true);
    }
}

function toggleAll(checked) {
    document.querySelectorAll('.label-checkbox').forEach(cb => {
        cb.checked = checked;
    });
}

async function generateSelectedPDF() {
    const checkboxes = document.querySelectorAll('.label-checkbox:checked');
    
    if (checkboxes.length === 0) {
        showAlert('Please select at least one label to print', true);
        return;
    }
    
    const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
    
    // Open preview in same tab
    const params = new URLSearchParams();
    indices.forEach(idx => params.append('indices', idx));
    window.location.href = `/preview?${params.toString()}`;
}
</script>
{% endblock %}
